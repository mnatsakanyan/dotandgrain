(window.multistep_editor_jsonpFunction=window.multistep_editor_jsonpFunction||[]).push([[14],{933:function(e,t,s){"use strict";s.r(t),s.d(t,"AuWidgetAjax",function(){return a}),s.d(t,"widget",function(){return a});var r=s(0),o=s(172),n=(s(214),s(6)),i=s(1),c=s(44);let a=class extends o.a{constructor(){super(...arguments),this._isRestoring=!1,this._isLoaded=!1,this.enabled=!0,this.headers={},this.method="POST",this.responses=[],this.error=null,this.statusCode=null,this.responseHeaders=null,this.responseType="json",this.requestPromise=Promise.resolve(),this._requestPending=!1,this._lockList=[],this._fetchTimer=null,this._fetchDelay=50,this._currentAbortController=null}requestPendingObserver(e){this.showPreloader(e)}async _doFetch(e){if(n.a.isNotNullOrUndefined(this.requests)&&n.a.isNotEmptyArray(this.requests)){const t=this.requests.map(e=>{const t={enabled:void 0===e.enabled||e.enabled,_onSuccess:e.onSuccess?n.a.functionWrapperConstructor(e.onSuccess):this._onSuccess,_onError:e.onSuccess?n.a.functionWrapperConstructor(e.onError):this._onError,headers:e.headers?e.headers:this.headers,request:e.request?e.request:this.request,responseType:e.responseType?e.responseType:this.responseType,method:e.method?e.method:this.method,url:e.url?e.url:this.url};return this._createFetch(t)});Promise.all(t).then(t=>{this._fetchTimer=null,n.a.isNullableArray(t)||(this.responses=t,this.emitChange({responses:this.responses},!1)),e(t)})}else{let t={enabled:this.enabled,_onSuccess:this._onSuccess,_onError:this._onError,headers:this.headers,request:this.request,responseType:this.responseType,method:this.method,url:this.url};this._createFetch(t).then(t=>{this._fetchTimer=null,t&&(this.response=t,this.emitChange({response:this.response},!1)),e(t)})}}async _createFetch(e){if(n.a.isNotUndefined(e.url)){if(!1===e.enabled)return Promise.resolve(null);this._requestPending=!0;let t={method:e.method,redirect:"follow"};n.a.isObjectNotEmpty(e.request)&&(t.body=JSON.stringify(e.request)),-1!==["get","head"].indexOf(t.method.toLowerCase())&&delete t.body,(n.a.isObjectNotEmpty(e.headers)||t.body)&&(t.headers=new Headers(Object.assign(t.body?{"Content-type":"application/json"}:{},e.headers||{})));let s=new Request(e.url,t);this._currentAbortController=new AbortController;const r=e=>(this.statusCode=e.status,this.emitChange({statusCode:this.statusCode},!1),e),o=async t=>{if(t.ok)return t;const s=await t.text();try{const r={body:JSON.parse(s),headers:t.headers,statusCode:t.status};e._onError(r)}catch(t){e._onError()}throw Error(`[${t.status},${t.statusText}] : ${s}`)},i=async e=>(e.redirected&&(s=new Request(e.url,t),e=await fetch(s,{signal:this._currentAbortController.signal})),e);e._currentFetch=fetch(s,{signal:this._currentAbortController.signal}).then(i).then(r).then(o).then(async t=>{switch(this.statusCode=t.status,this.responseHeaders=t.headers,this.emitChange({responseHeaders:this.responseHeaders},!1),e.responseType){case"text":return t.text().then(e=>e.replace(/^"/g,"").replace(/\"$/g,""));case"status_code":return t.status;case"blob":return t.blob();case"json":try{return await t.clone().json()}catch(e){let s=Error(`\n[request url: ${t.url}, request status code: ${t.status}] \n`+`unexpected error: ${e} \nresponse body: \n${await t.clone().text()}\n`);return Promise.reject(s)}case"blob_url":return t.blob().then(e=>URL.createObjectURL(e));default:return t.text()}}).then(t=>(e.error=null,e.response=t,this.response=t,e._onSuccess(),e.response)).catch(t=>{"AbortError"===t.name||(e.error=t,this.error=t,e._onError(),console.error(t))}).finally(()=>{this._requestPending=!1})}return e._currentFetch||Promise.resolve(null)}updateParams(e){let t=c.Maybe.maybe(e);this._onSuccess=n.a.functionWrapperConstructor(e.onSuccess),this._onError=n.a.functionWrapperConstructor(e.onError),this.enabled=t.map(e=>e.enabled).caseOf({just:e=>e,nothing:()=>this.enabled}),this.headers=t.map(e=>e.headers).caseOf({just:e=>e,nothing:()=>this.headers}),this.request=t.map(e=>e.request).caseOf({just:e=>e,nothing:()=>this.request}),this.requests=t.map(e=>e.requests).caseOf({just:e=>e,nothing:()=>this.requests}),this.responseType=t.map(e=>e.responseType).caseOf({just:e=>e,nothing:()=>this.responseType}),this.method=t.map(e=>e.method).caseOf({just:e=>e,nothing:()=>this.method}),this.url=t.map(e=>e.url).caseOf({just:e=>e,nothing:()=>this.url}),this.responses=[]}async updateParamsAsync(e){return await super.updateParamsAsync(e),this._lockList=e.lock?e.lock instanceof Array?e.lock:[e.lock]:[],this._isLoaded||(this.getInitialParamsResolved(),this._isLoaded=!0),this._doFetchDebounce()}async exportWidgetData(e){return{response:this.response,responses:this.responses,headers:this.headers,status:this.statusCode}}async restoreWidgetFromData(e,t){e&&(this.response=e.response,this.responses=e.responses,this.headers=e.headers,this.statusCode=e.status,this.emitChange({response:this.response,responses:this.responses,headers:this.headers,statusCode:this.statusCode},!1))}showPreloader(e){(this._lockList||[]).forEach(t=>{let s="main"===t?this.auWizard:this.auWizard.scope.$[t]||this.jsonParamsFetcher.scope[t]||this.jsonParamsFetcher.scope.$[t];s&&s.showPreloader(e)})}_doFetchDebounce(){let e=null;this.requestPromise=new Promise(t=>{e=t});const t=new Promise(e=>{null!==this._fetchTimer&&(window.clearTimeout(this._fetchTimer),this._currentAbortController&&this._currentAbortController.abort()),this._fetchTimer=window.setTimeout(()=>{this._doFetch(e)},this._fetchDelay)});return t.then(()=>{setTimeout(()=>{setTimeout(()=>{setTimeout(()=>{setTimeout(()=>{setTimeout(()=>{e()},100)},100)},100)},100)},100)}),t}};Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Object)],a.prototype,"request",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Boolean)],a.prototype,"enabled",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Array)],a.prototype,"requests",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Object)],a.prototype,"headers",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",String)],a.prototype,"method",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",String)],a.prototype,"url",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Object)],a.prototype,"response",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Object)],a.prototype,"responses",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Object)],a.prototype,"error",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Number)],a.prototype,"statusCode",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Headers)],a.prototype,"responseHeaders",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",String)],a.prototype,"responseType",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Promise)],a.prototype,"requestPromise",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Boolean)],a.prototype,"_requestPending",void 0),Object(r.b)([Object(i.b)("_requestPending"),Object(r.d)("design:type",Function),Object(r.d)("design:paramtypes",[Object]),Object(r.d)("design:returntype",void 0)],a.prototype,"requestPendingObserver",null),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Function)],a.prototype,"_onSuccess",void 0),Object(r.b)([Object(i.c)(),Object(r.d)("design:type",Function)],a.prototype,"_onError",void 0),a=Object(r.b)([Object(i.a)("au-widget-ajax")],a)}}]);