(window.multistep_editor_jsonpFunction=window.multistep_editor_jsonpFunction||[]).push([[17],{510:function(e,t,s){"use strict";s.d(t,"a",function(){return o});var a=s(176),i=s(452);class o{static get iframeApiPromise(){return this._iframeApiSubject.pipe(Object(i.a)(1)).toPromise()}static loadCCScript(e,t){if("undefined"!=typeof CustomersCanvas||document.body.querySelector("#CcIframeApiScript"))"undefined"!=typeof CustomersCanvas&&this._iframeApiSubject.next(CustomersCanvas);else{this._iframeApiSubject=new a.a(1);let s=document.createElement("script");s.type="text/javascript",s.id="CcIframeApiScript",s.onload=(e=>{CustomersCanvas&&this._iframeApiSubject.next(CustomersCanvas)}),s.onerror=(e=>{this._iframeApiSubject.error(e)}),s.src=e+t,document.body.appendChild(s)}return this.iframeApiPromise}}o._iframeApiSubject=new a.a(1)},511:function(e,t,s){"use strict";s.d(t,"a",function(){return l});var a=s(512),i=s(31),o=s(750),n=s(6),r=s(592),c=s(68);class l{constructor(e,t,s=(()=>Promise.resolve())){this._lastJobKey="init",this._lastExecutedJobSubject=new a.BehaviorSubject("init"),this._commands=e,this._onJobFinish=s,this.logger=new c.Category("command-executer_"+t)}executeActions(e,t,s){const a=async o=>{this.logger.debug(()=>`Execute '${o}'`);let n=Promise.resolve();const r=this._commands[o];if(r&&void 0!==r.execute){n=r.execute(e[o],s[o]);let c=e[o].after;if(!c&&Array.isArray(e[o])){const t=e[o].find(e=>e.after);t&&(c=t.after)}if(void 0!==c){Object(i.a)(c)||(c=[c]);const e=(e,t,s)=>{const a=s.indexOf(e);return s.indexOf(t)>a};for(let s=0;s<c.length;s++){const i=c[s];e(o,i,t)||(await n,n=a(i))}}}else console.warn(`Action ${o} is not supported! Double check the config.`);return n},o=this.getJobReady(this._lastJobKey),r=this._lastJobKey=n.a.guid();return o.then(()=>(this.logger.debug(()=>`Start actons: ${t}`),n.a.recursiveJobPromise(t,a))).then(()=>this._onJobFinish()).finally(()=>{this.logger.debug(()=>`End actons: ${t}`),this._lastExecutedJobSubject.next(r)})}getJobReady(e){return this._lastExecutedJobSubject.pipe(Object(r.filter)(t=>t===e),Object(r.take)(1)).toPromise()}getChangedActions(e,t){const s=Object.keys(e).filter(t=>n.a.isObjectNotEmpty(e[t])).filter(s=>void 0===t[s]||!((e,t)=>JSON.stringify(e)===JSON.stringify(t))(e[s],t[s])),a=s.indexOf("actionsErrorToast");return-1!==a&&s.splice(a,1),s.indexOf("initial")>-1?["initial"].concat(Object(o.a)(s,"initial")):s}}},758:function(e,t){e.exports="<style>\n    :host {\n        width: 100%;\n        height: 100%;\n        display: block;\n        position: relative;\n    }\n\n    #editorFrame {\n        position: absolute;\n        height: 1px;\n        min-height: 100%;\n        width: 1px;\n        min-width: 100%;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        border: none;\n        background-color: transparent;\n    }\n</style>\n<iframe id='editorFrame' allowfullscreen></iframe>"},958:function(e,t,s){"use strict";s.r(t),s.d(t,"AuWidgetCanvas",function(){return b}),s.d(t,"widget",function(){return b});var a,i=s(0),o=s(758),n=s(172),r=s(178),c=s(452);class l{constructor(e){Object.assign(this,e)}}class d{constructor(e){this.widget=e}}class u{constructor(e,t,s){this.definition=e,this.surfaceIndex=t,this.all=s}}!function(e){e.canvas="canvas",e.config="config"}(a||(a={}));var m=s(44),g=s(6);var h=s(31);var f=s(510),p=s(1),C=s(16),w=s(511),v=s(507),I=s(579);let b=class extends class extends n.c{constructor(){super(...arguments),this._customersCanvasSubject=new r.ReplaySubject(1)}customersCanvasPublish(e){this._customersCanvasSubject.next(e)}get customersCanvasObservable(){return this._customersCanvasSubject.asObservable()}get customersCanvasPromise(){return this.customersCanvasObservable.pipe(Object(c.a)(1)).toPromise()}__methodExecuter(e,...t){const s=new RegExp(/^async function\s*\(\s*([^)]*)\s*\)\s*=>\s*/);let a=Array.from(arguments);if(null!==(async e=>{console.log(e)}).toString().match(s)){const e=(e,t)=>{let a=e.toString();const i=a.match(s);if(i){const e=i[1];a=a.replace(s,`async (${e}) => `)}return`\n                var execFunc = (${a});\n                var args = ${JSON.stringify(t.map(e=>JSON.stringify(e)))};\n                var parseParam = function(params) {\n                    if (Array.isArray(params)) { \n                        return params.map(function(x) { return JSON.parse(x); })\n                    } else {\n                        return [params];\n                    }\n                }; \n                execFunc.apply(null, parseParam(args))`};a[0]=e(a[0],t)}let i=null;try{i=arguments.callee.caller}catch(e){i="function"==typeof arguments[0]?arguments[0]:void 0}let o=i?i.name:"unknown function";return this.customersCanvasPromise.then(e=>e.eval.apply(e,a)).catch(e=>{if(console.error(e),!o&&i)for(let e in this)if(this.hasOwnProperty(e)&&i===this[e]){o=e;break}throw"Failed to call "+o})}getReady(){const e=function(){let e=spEditor.getCanvasViewer().get_canvas().get_layers().toArray().filter(e=>e._visible),t=[].concat(...e.map(e=>e.get_vObjects().toArray().filter(e=>e.isVisible()&&!e.get_ready())));return t.map(e=>new Promise(t=>{try{e.add_ready(function s(){e.remove_ready(s),t()})}catch(e){t()}})),Promise.all(t)};return this.customersCanvasPromise.then(()=>this.__methodExecuter(e)).then(()=>new Promise(e=>{window.setTimeout(e,100)}))}async getCanvasItemModel(e){const t=await this.__methodExecuter(e=>{const t=JSON.parse(e);let s=spEditor.productHandler.getAllItems().find(e=>e.id===t.id);if(s||(s=spEditor.productHandler.getAllItems().find(e=>e.name===t.name)),!s)return;let a={id:s.id,name:s.name};switch(!0){case s instanceof CustomersCanvas.Model.PlaceholderItem&&null!==s.content&&void 0!==s.content&&s.content instanceof CustomersCanvas.Model.ImageItem&&!(s.content instanceof CustomersCanvas.Model.BarcodeItem)&&null!==s.content.tags.sourceData&&void 0!==s.content.tags.sourceData:{const e=s.parentContainer.parentComponent.parentSurface.name,t=s.getTransformedRectangle(),i=s.content.getTransformedRectangle(),o=Aurigma.GraphicsMill.AjaxControls.VectorObjects.Math,n=o.normalizeAngle(i.Angle-t.Angle),r=i.clone(),c=t.clone();r.rotateAt(o.normalizeAngle(-r.Angle),c.get_center()),c.Angle=0;const l=spEditor.productHandler.product.getCurrentSurface().getPrintAreas()[0],d=spEditor.configuration.renderingConfig.getHiResRendering(l),u=s.content;a.tags=angular.copy(u.tags),a.value=u.tags.sourceData.name,a.surfaceName=e,a.placeholderContent={originalUrl:u.tags.sourceData.originalUrl+"?x-cctoken="+spEditor.configuration.tokenId,width:u.source.width,height:u.source.height,placeholderRectangle:t,contentRectangle:i,placeholderRectangleWithoutAngle:c,contentRectangleWithoutPlaceholderAngle:r,contentAngle:n,dpi:d.dpi};break}case s instanceof CustomersCanvas.Model.PlaceholderItem&&s.content&&s.content instanceof CustomersCanvas.Model.ImageItem:{const e=s.parentContainer.parentComponent.parentSurface.name;a={name:s.name,tags:angular.copy(s.tags),surfaceName:e};break}case s instanceof CustomersCanvas.Model.BaseTextItem&&!!s.text:{const e=s;let t="",i=e=>(e/255).toFixed(7);e.color instanceof Aurigma.GraphicsMill.AjaxControls.VectorObjects.RgbColor?t=`rgb(${e.color.R},${e.color.G},${e.color.B},${i(e.color.A)})`:e.color instanceof Aurigma.GraphicsMill.AjaxControls.VectorObjects.CmykColor&&(t=`cmyk(${i(e.color.C)},${i(e.color.M)},${i(e.color.Y)},${i(e.color.K)},${i(e.color.A)})`),a={name:s.name,value:e.text,color:t,font:{postScriptName:e.font.postScriptName,size:e.font.size,fauxBold:e.font.fauxBold,fauxItalic:e.font.fauxItalic}};break}}return s.contentPermissions&&s.contentPermissions.imagePermissions&&(a.contentPermissions={imagePermissions:{allowChangeImage:s.contentPermissions.imagePermissions.allowChangeImage,allowEditImage:s.contentPermissions.imagePermissions.allowEditImage}}),s.placeholderPermissions&&(a.placeholderPermissions={allowEditContent:s.placeholderPermissions.allowEditContent,showHandleButton:s.placeholderPermissions.showHandleButton,showSelectButton:s.placeholderPermissions.showSelectButton}),s.visualizationPermissions&&(a.visualizationPermissions={noPrint:s.visualizationPermissions.noPrint,noShow:s.visualizationPermissions.noShow}),null!==s.locked&&(a.locked=s.locked),a},JSON.stringify(e));return this.fireChangeItemEvent(t),new l(t)}}{constructor(){super(...arguments),this.CC_SCRIPT_RELATIVE_PATH="/Resources/SPEditor/Scripts/IFrame/IframeApi.js",this.modifiedItem=null,this._currentSurfaceName="",this.overallBounds={},this._hiResUrls=[],this._proofImageUrls=[[]],this._stateId="",this._userId="",this._variableData=[],this._allItems=[],this._depositPhotos=[],this._tags={},this._lastParams={},this._currentParams={},this.actionsFinished=!1,this.itemsData={},this.commands={initial:new class extends d{async execute(e){await this.widget.iframeApiPromise,"string"==typeof e.productDefinition&&(e.editorConfig.autoLoadUserInfo=!1,e.editorConfig.userInfo=null,this.widget._stateId=e.productDefinition,this.widget._userId=this.widget.driver.user.id),await this.load(e.productDefinition,e.editorConfig,e.maximizeAssetManager||e.galleryObserverEnable);try{await this.widget.getReady()}catch(e){console.error("Failed getReady() on widget canvas")}return m.Maybe.maybe(e).map(e=>e.viewerSettings).caseOf({just:e=>this.widget.applyViewerSettings(e),nothing:()=>this.widget.customersCanvasPromise})}async load(e,t,s){const a=this;e.surfaces&&Array.isArray(e.surfaces)&&e.surfaces.forEach(function(e){"object"==typeof e&&void 0!==e.width&&void 0!==e.height&&(e.width=Number(e.width),e.height=Number(e.height))}),a.widget.modifiedItem&&a.widget.updateModifiedItem({});const i=this.widget.shadowRoot.querySelector("#editorFrame"),o=await CustomersCanvas.IframeApi.loadEditor(i,e,t);let n;this.listenBoundsChanges(o);try{(n=await o.getProduct()).switchTo(n.surfaces[0])}catch(e){return console.error("Load failed with exception: ",e),void a.widget.dispatchEvent(new CustomEvent("error",e))}a.listenItemChanges(o),a.listenSurfaceChanges(o),a.updateOverallBounds(o),a.widget.customersCanvasPublish(o),a.widget.dispatchEvent(new CustomEvent("ready",{detail:{product:n,customersCanvas:o}})),await this.widget.replaceInterpolationPlaceholder(),s&&(a.listenModalClose(o),a.listenModalOpen(o),a.listenAssetManagerClose(o),a.listenAssetManagerOpen(o)),a.listenOriginalSize(o),a.listenFullWindow(o)}async listenItemChanges(e){await e.eval(function(){spEditor.productHandler.itemChangedEvent.add(function(e){const t={name:e.name,id:e.id};this.spEditor._postMessageServer.notifySubscribers("itemChanged",JSON.stringify(t))})}),e.subscribe("itemChanged",async e=>{const t=JSON.parse(e),s=await this.widget.getCanvasItemModel(t),a=new l(s);this.widget.updateModifiedItem(a)})}listenBoundsChanges(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.BoundsNotification,function(e){t.widget.updateOverallBounds(e.overallBounds)})}listenSurfaceChanges(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.OnSurfaceChanged,function(e){t.widget.updateCurrentSurfaceName()})}updateOverallBounds(e){const t=this;e.eval(()=>spEditor.injector.get(CustomersCanvas.SimplePolygraphy.IBoundsNotifier.injectName).getOverallBounds()).then(e=>t.widget.updateOverallBounds(e))}listenOriginalSize(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.OriginalSize,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenFullWindow(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.FullWindow,()=>{t.widget.toggleMaximizeMainPanel(!0)})}listenModalClose(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.ModalClose,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenModalOpen(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.ModalOpen,()=>{t.widget.toggleMaximizeMainPanel(!0)})}listenAssetManagerClose(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.AssetManagerClosed,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenAssetManagerOpen(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.AssetManagerOpened,()=>{t.widget.toggleMaximizeMainPanel(!0)})}}(this),changeMockup:new class extends d{async execute(e){let t=await this.widget.customersCanvasPromise,s=await t.getProduct(),a=e.data.map((e,t)=>({mockup:e.mockup,previewMockups:e.previewMockups,surface:s.surfaces[t]}));return s.setMockups(a,e.options)}}(this),changeLayout:new class extends d{async execute(e,t){this.widget.modifiedItem&&this.widget.updateModifiedItem({});const s=e=>{const t="number"==typeof e.sourceSurfaceIndex?spEditor.productHandler.product.getSurfaces()[e.sourceSurfaceIndex]:spEditor.productHandler.product.getCurrentSurface(),s={canvasSourceRectangleSize:{width:t.width,height:t.height}},a=t.getPrintAreas()[0].items,i=a.filter(e=>e.parentContainer.name===CustomersCanvas.Configuration.MAIN_CONTAINER_NAME),o=CustomersCanvas.Configuration.getProductSerializer();if(s.rawMainItems=i.map(e=>JSON.parse(o.serializeModelComponent(e))),!e.removeBackground){const e=a.filter(e=>e.parentContainer.name===CustomersCanvas.Configuration.BG_CONTAINER_NAME);e.forEach(e=>e.itemPermissions.allowRemoveOnLayoutChange=!1),s.rawBgItems=e.map(e=>JSON.parse(o.serializeModelComponent(e)))}return s},i=async(e,t,s)=>{const a=((()=>!("number"!=typeof s||(s<0||s>=spEditor.productHandler.product.getSurfaces().length)&&(console.error("deSerializeSurface: surfaceIndex is out of boundaries."),1)))()?spEditor.productHandler.product.getSurfaces()[s]:spEditor.productHandler.product.getCurrentSurface()).getPrintAreas()[0].getContainers(),i=a.find(e=>e.name===CustomersCanvas.Configuration.MAIN_CONTAINER_NAME),o=a.find(e=>e.name===CustomersCanvas.Configuration.BG_CONTAINER_NAME),n=(e,t,s=[])=>{const a=CustomersCanvas.Configuration.getProductSerializer(),i=e.map(e=>a.productParser.parseItem(e));t.setItems(s.concat(i)),spEditor.productHandler._subscribeToItemEvents(i)};return t.discardChanges?n(e.rawMainItems,i):(e.data=e.rawMainItems.concat(e.rawBgItems||[]),await spEditor.widgetsController.addLayoutItems(e)),t.removeBackground||n(e.rawBgItems||[],o,o.getItems()||[]),spEditor.productHandler.updateView(),spEditor.productHandler.getProductUpdateEvent().fire(),spEditor.getCanvasViewer().get_canvas().waitWebServiceCalls()},o=await this.widget.customersCanvasPromise,n=e.map((e,t)=>new u(e.data,t,e)).filter((e,s)=>m.Maybe.maybe(t).map(t=>t[e.surfaceIndex]).caseOf({just:t=>JSON.stringify(e.all)!==JSON.stringify(t),nothing:()=>!0}));return await g.a.recursiveJobPromise(n,async e=>{e.definition||console.warn("changeLayout: skipping because definition = null");let t=null,n=e.definition;switch(typeof n){case"string":t=n;break;case"object":t={surfaces:[n]};break;default:console.error("changeLayout: Unexpected data type of "+JSON.stringify(n))}let r=g.a.createNodeFromString('<iframe style="position:fixed;top:-1000px;left:-1000px;z-index:0;opacity:0;max-width:0;max-height:0;display:block"></iframe>');document.body.appendChild(r);let c=m.Maybe.maybe(this.widget.params).map(e=>e.initial).map(e=>e.editorConfig),l=await CustomersCanvas.IframeApi.loadEditor(r,t,{initialMode:c.caseOf({just:e=>e.initialMode,nothing:()=>CustomersCanvas.IframeApi.Configuration.ModelMode.Simple}),restoreProductOnReloadEnabled:!1,preloader:{enabled:!1},rendering:{hiResOutputDpi:300},userId:c.caseOf({just:e=>e.userId,nothing:()=>"default"})});if(g.a.isNotNullOrUndefined(e.all.dimesions)){let t,s,i,n;switch(a[e.all.dimesions]){case a.config:t=l,s=o,i=0,n=e.surfaceIndex;break;case a.canvas:default:t=o,s=l,i=e.surfaceIndex,n=0}let r=await this.getSurfaceDimension(t,i);await this.setSurfaceDimension(s,r,n)}let d=await l.eval(s,e.all,e.surfaceIndex);await o.eval(i,d,e.all,e.surfaceIndex);let u=await this.getSurfaceRenderingConfig(l);await this.setSurfaceRenderingConfig(o,u,e.surfaceIndex),await m.Maybe.maybe(e.all).map(e=>e.viewerSettings).caseOf({just:e=>this.widget.applyViewerSettings(e),nothing:()=>this.widget.customersCanvasPromise}),document.body.removeChild(r)}),await this.widget.replaceInterpolationPlaceholder(),this.widget.getReady()}async getSurfaceDimension(e,t){return e.eval(e=>{let t=spEditor.model.product,s=t.getCurrentSurface();return"number"==typeof e&&(e<0||e>=t.getSurfaces().length?(console.warn("getSurfaceDimensions: surfaceIndex is out of boundaries."),s=t.getCurrentSurface()):s=t.getSurfaces()[e]),{width:s.width,height:s.height}},t).catch(function(e){console.log("Sorry for a failure"),console.log(e)})}async setSurfaceDimension(e,t,s){return e.eval(e=>{let t=spEditor.model.product,a=t.getCurrentSurface();"number"==typeof s&&((s<0||s>=t.getSurfaces().length)&&console.error("setSurfaceDimensions: surfaceIndex is out of boundaries."),a=t.getSurfaces()[s]);let i=a.getPrintAreas()[0];a.width=e.width,a.height=e.height,i.bounds.Width=a.width,i.bounds.Height=a.height},t).catch(function(e){console.log("Sorry for a failure"),console.log(e)})}async getSurfaceRenderingConfig(e,t){return e.eval(e=>{let t=spEditor.model.product,s=t.getCurrentSurface();"number"==typeof e&&(e<0||e>=t.getSurfaces().length?console.error("getSurfaceRenderingConfig: surfaceIndex is out of boundaries."):s=t.getSurfaces()[e]);let a=spEditor.configuration.renderingConfig.perSurfacePartialConfigs[s.name];return Object.assign({},a)},t).catch(function(e){console.log("Sorry for a failure"),console.log(e)})}async setSurfaceRenderingConfig(e,t,s){return e.eval((e,t)=>{let s=spEditor.model.product,a=s.getCurrentSurface();"number"==typeof t&&(t<0||t>=s.getSurfaces().length?(console.warn("setSurfaceRenderingConfig: surfaceIndex is out of boundaries."),a=s.getCurrentSurface()):a=s.getSurfaces()[t]);let i=spEditor.configuration.renderingConfig.perSurfacePartialConfigs;if(e.hiResOutput)for(let t in e.hiResOutput)null!==e.hiResOutput[t]&&void 0!==e.hiResOutput[t]&&(i[a.name].hiResOutput[t]=e.hiResOutput[t]);if(e.proofImage)for(let t in e.proofImage)null!==e.proofImage[t]&&void 0!==e.proofImage[t]&&(i[a.name].proofImage[t]=e.proofImage[t])},t,s).catch(function(e){console.log("Sorry for a failure"),console.log(e)})}}(this),setPrintArea:new class extends d{async execute(e){let t=await this.widget.customersCanvasPromise,s=await t.getProduct();Object(h.a)(e)||(e=[e]);for(let t=0;t<e.length;t++){const a=e[t];let i=s.currentSurface;"number"==typeof a.surfaceIndex&&(i=s.surfaces[a.surfaceIndex]),s=await i.setPrintAreas([a.data],a.options)}return Promise.resolve()}}(this),setTheme:new class extends d{async execute(e){"string"==typeof e?e={theme:e}:void 0===e.theme&&(e={theme:e});let t=await this.widget.customersCanvasPromise;return(await t.getProduct()).applyProductTheme(e.theme)}}(this),setBackground:new class extends d{async execute(e){let t=await this.widget.customersCanvasPromise;return e.url&&await t.eval(e=>{let t=spEditor.productHandler._app.configuration.appDomainUrl,s=spEditor.model.product,a=null,i=(a=void 0===e.surfaceIndex||null===e.surfaceIndex?s.getCurrentSurface():s.getSurfaces()[e.surfaceIndex]).getPrintAreas()[0],o=i.getContainers().find(e=>e.name===CustomersCanvas.Configuration.BG_CONTAINER_NAME),n=o.getItems()[0],r=n.content,c=(e,t,s)=>{if(!0!==e)return[s];let a=[],i=0,o=0;for(;o<t.height;){for(;i<t.width;){let e=s.clone();e.transform.set_translateX(i),e.transform.set_translateY(o),e.locked=!0,a.push(e),i+=s.sourceWidth||s.source.width}i=0,o+=s.sourceHeight||s.source.height}return a};if(!e.url.startsWith("public:")&&!e.url.startsWith("private:"))return r.loadImageFromRemoteUrl(t,e.url).then(function(){var t;this.isVector=!0,this.source&&(this.source.isVector=!0),e.autoResize&&(t=this,a.width=t.sourceRectangle.Width,a.height=t.sourceRectangle.Height,i.bounds.Width=a.width,i.bounds.Height=a.height);let s=c(e.toTile,a,this);o.setItems(s),spEditor.productHandler.updateView()}.bind(n)).catch(function(e){console.log("Sorry for a failure"),console.log(e)});{let s=e.url,i=spEditor.configuration.userId||this.widget.userId||"default";Utils.ItemUtils.getImageMetaDataFromFile(t,s,i).then(function(t){let s=t;if((e.url.endsWith(".pdf")||e.url.endsWith(".svg"))&&(s.isVector=!0),e.toTile){let t=this.content||this;t.sourceRectangle.Width=s.size.width,t.sourceRectangle.Height=s.size.height,t.setData(s),(e.url.endsWith(".pdf")||e.url.endsWith(".svg"))&&t.source&&(t.source.isVector=!0);let i=c(e.toTile,a,t);o.setItems(i),spEditor.productHandler.updateView()}else spEditor._widgetsController.changeBackground([a],s)}.bind(n)).catch(function(e){console.log("Sorry for a failure"),console.log(e)})}},e),this.widget.getReady()}}(this),updateContainerSettings:new class extends d{async execute(e){if(e&&e instanceof Array){let t=await this.widget.customersCanvasPromise,s=await t.getProduct();e.forEach((e,t)=>{let a=Object.keys(e),i=Object.values(e),o=a.length,n=s.surfaces[t];if(n)for(let e=0;e<o;e++){let t=a[e],s=n.printAreas[0].getContainer(t);s?s.update(i[e]):console.warn(`Container with name ${t} was not found!`)}})}}}(this),setRemoteMockup:new class extends d{async execute(e){return(await this.widget.customersCanvasPromise).eval(function(e){let t=spEditor.productHandler.product.getSurfaces();e.forEach(e=>{if(e.url){const s="number"==typeof e.surfaceIndex?t[e.surfaceIndex]:spEditor.productHandler.product.getCurrentSurface(),a=("up"===e.mockup.toLowerCase()?s.mockup.getUpContainers():s.mockup.getDownContainers())[0].getItems()[0];if(a){const t=this.window.location.href.split("/page/iframe")[0]+"/api/ImagePicker/GetWebImageMeta",s={url:e.url};$.ajax({method:"post",async:!1,url:t,contentType:"application/json;charset=UTF-8",data:JSON.stringify(s),success:function(e){const t=new CustomersCanvas.Model.ImageMetaData(e);t.size={width:t.size.width||t.width,height:t.size.height||t.height},t.name=a.name,spEditor._widgetsController.setImageData(a,t),spEditor.productHandler.updateView()}})}}})},e)}}(this),modifyItems:new class extends d{async execute(e,t){if(g.a.isEmptyObject(e)||g.a.isEmptyObject(e.every)&&g.a.isEmptyObject(e.items))return Promise.resolve();const s=await this.widget.customersCanvasPromise;return e.items=e.items||{},t&&(e=((e,t)=>{for(const s in e.items){const a=t.items[s],i=e.items[s];JSON.stringify(a)===JSON.stringify(i)&&!0!==i.force&&delete e.items[s]}return e})(e,t)),g.a.isEmptyObject(e.items),await this.widget.__methodExecuter(async e=>{const t=spEditor.model.product.getAllItems(),s=[],a=async e=>{if(e.toLowerCase().startsWith("cmyk")){let t=(e=>{let t=[];return Array.from(e.match(/\d+(\.\d+)?%?/g)).map((e,s)=>{let a=e.replace("%",""),i=Number(a);i<=1&&-1===e.indexOf("%")&&(i*=100),t[s]=i}),{C:255*t[0]/100,M:255*t[1]/100,Y:255*t[2]/100,K:255*t[3]/100,A:255*(t[4]||100)/100}})(e),s=new Aurigma.GraphicsMill.AjaxControls.VectorObjects.CmykColor(t);return s.Preview=await(async e=>{let t=encodeURIComponent(e.toString()),s=window.location.href.split("/page/iframe")[0]+"/api/ColorConvertor/CmykToRgb/"+t+"/id/";return Ajax.request({url:s,type:Ajax.RequestType.post,headers:[Ajax.ContentType.json]}).then(e=>JSON.parse(e.value).value).catch(e=>{console.error("failed to get color preview: "+e)})})(s),s}{let t=(e=>{let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{A:255,R:parseInt(t[1],16),G:parseInt(t[2],16),B:parseInt(t[3],16)}:null})(e);return new Aurigma.GraphicsMill.AjaxControls.VectorObjects.RgbColor(t)}};e&&e.items&&await(async e=>{let t=e.items.background;if(t&&t.color){let e=spEditor.model.product;for(const s of e.getSurfaces()){let e=await a(t.color),i=s.getBackgroundItem(),o=spEditor.widgetsController;try{o._selectBgColor(i,e)}catch(t){o.selectBgColor(e)}}}})(e);const i=e=>e.placeholderContent&&e.tags&&e.tags.sourceData&&e.value===e.tags.sourceData.name;for(const o of t){const t=Object.assign(Object.assign({},e.every),e.items[o.name]);if(0!==Object.keys(t).length){if(o instanceof CustomersCanvas.Model.Item&&(t.visualizationPermissions&&(null!=t.visualizationPermissions.noPrint&&(o.visualizationPermissions.noPrint=t.visualizationPermissions.noPrint),null!=t.visualizationPermissions.noShow&&(o.visualizationPermissions.noShow=t.visualizationPermissions.noShow)),null!=t.locked&&(o.locked=t.locked)),o instanceof CustomersCanvas.Model.PlaceholderItem){if("ImagePlaceholder"===t.type){if(i(t)){const e=CustomersCanvas.Utils.ItemUtils.getImageMetaDataFromUrl(spEditor.configuration.appDomainUrl,t.placeholderContent.originalUrl).then(function(e){o.content=new CustomersCanvas.Model.ImageItem,o.content.setData(e),o.content.updateRectangle(!1,o.contentResizeMode,o),o.content.tags=t.tags,o.isStubContent=!1;const s=o.getTransformedRectangle(),a=t.placeholderContent;if(s.Angle===a.placeholderRectangle.Angle&&s.Width===a.placeholderRectangle.Width&&s.Height===a.placeholderRectangle.Height&&s.CenterX===a.placeholderRectangle.CenterX&&s.CenterY===a.placeholderRectangle.CenterY){const e=Aurigma.GraphicsMill.AjaxControls.VectorObjects.Math,t=new e.RotatedRectangleF(a.placeholderRectangle.CenterX,a.placeholderRectangle.CenterY,a.placeholderRectangle.Width,a.placeholderRectangle.Height,a.placeholderRectangle.Angle);o.setTransformedRectangle(t);const s=new e.RotatedRectangleF(a.contentRectangle.CenterX,a.contentRectangle.CenterY,a.contentRectangle.Width,a.contentRectangle.Height,a.contentRectangle.Angle);o.content.setTransformedRectangle(s)}});s.push(e)}else o.isStubContent||(o.content=new CustomersCanvas.Model.ImageItem,o.content.setData(o.stubStorageMeta),o.isStubContent=!0);t.contentPermissions&&t.contentPermissions.imagePermissions&&(o.contentPermissions.imagePermissions.allowChangeImage=t.contentPermissions.imagePermissions.allowChangeImage,o.contentPermissions.imagePermissions.allowEditImage=t.contentPermissions.imagePermissions.allowEditImage),t.placeholderPermissions&&(o.placeholderPermissions.allowEditContent=t.placeholderPermissions.allowEditContent,o.placeholderPermissions.showHandleButton=t.placeholderPermissions.showHandleButton,o.placeholderPermissions.showSelectButton=t.placeholderPermissions.showSelectButton)}"BarcodePlaceholder"===t.type&&(t.value||o.isStubContent||(o.content.setData(o.stubStorageMeta),o.isStubContent=!0))}if(o instanceof CustomersCanvas.Model.BaseTextItem){let e=t.text||t.value;if(null!=e&&(o.text=e),o.placeholders&&o.placeholders.length>0&&(o.placeholders.forEach(function(t){t.value=e}),o.value=e),t.font){let e=t.font.leading||t.leading;e&&(o.leading=e);let s=t.font.bold||t.font.fauxBold;s&&(o.font.fauxBold=s);let i=t.font.italic||t.font.fauxItalic;i&&(o.font.fauxItalic=i);let n=t.font.family||t.font.postScriptName;n&&(o.font.postScriptName=n),t.font.size&&(o.font.size=t.font.size),t.font.underline&&(o.underline=t.font.underline);let r=t.color||t.font.color;r&&(o.color=await a(r))}if(!0===t.locked&&(o.textPermissions.allowChangeText=!1,o.textPermissions.allowChangeTextBIU=!1),o instanceof CustomersCanvas.Model.PlainTextItem){let e=t.position||t.location;if(e){let t=0,s=0;o.alignment=CustomersCanvas.Model.BaseTextItem.TextAlignment.Left,e||(e={x:0,y:0}),t=e.x||o.baselineLocation.X,s=e.y||o.baselineLocation.Y,o.baselineLocation=new Aurigma.GraphicsMill.AjaxControls.VectorObjects.Math.PointF(t,s)}}if(o instanceof CustomersCanvas.Model.BoundedTextItem||o instanceof CustomersCanvas.Model.AutoScaledTextItem){let e=t.position||t.location;if(e||t.size){let s=0,a=0,i=0,n=0;e||(e={x:0,y:0}),s=e.x||o.textRectangle.Left,a=e.y||o.textRectangle.Top,t.size||(t.size={width:0,height:0}),i=t.size.width||o.textRectangle.Width,n=t.size.height||o.textRectangle.Height,o.textRectangle.Width=i,o.textRectangle.Height=n,o.textRectangle.Left=s,o.textRectangle.Top=a}}}if(o.type===CustomersCanvas.Model.ShapeItem.type){let e=o,s=t.color||t.fillColor;s&&(e.fillColor=await a(s));let i=t.position||t.location;if(i||t.size){let s=0,a=0,o=0,n=0;i||(i={x:0,y:0}),s=i.x||e.sourceRectangle.Left,a=i.y||e.sourceRectangle.Top,t.size||(t.size={width:0,height:0}),o=t.size.width||e.sourceRectangle.Width,n=t.size.height||e.sourceRectangle.Height,e.sourcePath=Aurigma.GraphicsMill.AjaxControls.VectorObjects.Math.Path.rectangle(s,a,o,n)}}}}return Promise.all(s).then(()=>(spEditor.productHandler.updateView(),spEditor.getCanvasViewer().get_canvas().waitWebServiceCalls()))},e),await this.applyUserInfo(s,e),e&&e.items&&await this.widget.__methodExecuter(async e=>{const t=async(e,t,s)=>{if(null==e||null==e.effect)return Promise.resolve();let a=window.location.href.split("/page/iframe")[0]+"/api/ImageEditor/ProcessImage/",i=CustomersCanvas.Utils.urlCombine(a,s.storageId),o={effects:[new Aurigma.GraphicsMill.AjaxControls.VectorObjects.Effects.FiltersEffect(0,0,0,0,"grayscale"===e.effect.toLowerCase(),"sepia"===e.effect.toLowerCase())]};return Ajax.request({url:i,type:Ajax.RequestType.post,headers:[Ajax.ContentType.json],data:JSON.stringify(o)}).then(e=>{let s=JSON.parse(e.value);t.setData(s)}).catch(e=>{console.error(e),console.error("Failed to apply effect "+e)})},s=spEditor.model.product.getAllItems();for(const a of s){let s=e.items[a.name];if(!s||!s.effect)continue;let i=null;a instanceof CustomersCanvas.Model.ImageItem&&(i=a),a instanceof CustomersCanvas.Model.PlaceholderItem&&null!=a.content&&a.content.type==CustomersCanvas.Model.ImageItem.type&&(i=a.content),null!==i&&await t(s,i,i.getImageMetaData())}},e),Promise.resolve()}async applyUserInfo(e,t){const s=e=>!!e.placeholderContent&&e.tags&&e.tags.sourceData&&e.value===e.tags.sourceData.name,a={};for(const e of Object.keys(t.items)){const i=t.items[e];(i.value||"Text"===i.type||"InString"===i.type||i.image)&&("ImagePlaceholder"===i.type&&s(i)||("BarcodePlaceholder"===i.type?i.barcodeSubType&&"None"!==i.barcodeSubType?"Url"===i.barcodeSubType?a[e]={barcodeFormat:i.barcodeFormat,barcodeSubType:i.barcodeSubType,url:i.value}:"Phone"===i.barcodeSubType&&(a[e]={barcodeFormat:i.barcodeFormat,barcodeSubType:i.barcodeSubType,phone:i.value}):a[e]={barcodeFormat:i.barcodeFormat,barcodeValue:i.value}:a[e]=i.value||i.image))}return g.a.isEmptyObject(a)?Promise.resolve():e.loadUserInfo(a).then(()=>this.widget.__methodExecuter(e=>{const t=spEditor.productHandler.getAllItems().filter(t=>-1!==e.indexOf(t.name));spEditor.productHandler.updateItems(t)},Object.keys(a))).catch(e=>{this.widget.showToast("Error: Invalid data"),console.log(e)})}}(this),setViewerSettings:new class extends d{async execute(e){return(await this.widget.customersCanvasPromise).eval(function(e){if(void 0!==e.zoom&&spEditor.getCanvasViewer().set_zoom(e.zoom),void 0!==e.zoomMode){let t=Aurigma.GraphicsMill.ZoomMode[e.zoomMode];spEditor.getCanvasViewer().set_zoomMode(void 0!==t?t:1)}void 0!==e.scrollPosition&&spEditor.getCanvasViewer().set_scrollingPosition(e.scrollPosition)},e)}}(this)},this._isRestoring=!1}get violationWarningData(){return this._violationWarningData}get boundsData(){return this._boundsData}get currentSurfaceName(){return this._currentSurfaceName}get proofImageUrls(){return this._proofImageUrls}get hiResUrls(){return this._hiResUrls}get stateId(){return this._stateId}get userId(){return this._userId}get userChanges(){return this._userChanges}get allItems(){return this._allItems}get variableData(){return this._variableData}get depositPhotos(){return this._depositPhotos}get tags(){return this._tags}updateParams(e){if(void 0!==e.initial&&(e.initial.editorConfig||(e.initial.editorConfig={}),e.initial.editorConfig.defaultLanguage=this.driver.config.language||"en",this.driver)){this._initialOrder=this._initialOrder||Object(v.a)(this.driver.orders.current);const t=this.driver.user.id;t&&(e.initial.editorConfig.userId=t);const s=this.driver.user.tokenId;s&&(e.initial.editorConfig.tokenId=s);const a=this.auWizard.scopeInternal.widgetsData,i=a&&a[this.name]?a[this.name].stateId:this._initialOrder.data.stateId;i&&""!==i&&(e.initial.productDefinition=i),e.initial.editorConfig.preloader={enabled:!1}}this.onChange=e.onChange?g.a.functionWrapperConstructor(e.onChange):()=>{}}async exportWidgetData(e){return!0===e&&await this.saveProduct(),{stateId:this._stateId}}async restoreWidgetFromData(e,t=!1){if(!0===t){const t=Object.assign({},this.params.initial);t.productDefinition=e.stateId,await this.commands.initial.execute(t)}}async updateParamsAsync(e){await super.updateParamsAsync(e);let t=this._commandExecuter.getChangedActions(e,this._currentParams);if(0===t.length)return!1;if(-1!==t.indexOf("initial")){const s=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;let a=g.a.isNotNullOrUndefined(this._stateId)&&""!==this._stateId,i=g.a.isNotNullOrUndefined(e.initial.productDefinition)&&e.initial.productDefinition.toString().match(s);i&&(this._isRestoring=!0),(a||i)&&(t=["initial"])}this.actionsFinished=!1,this._isRestoring||this.emitChange();let s=t&&1===t.length&&-1!==t.indexOf("initial");this.showPreloader(!0,this.getPreloaderMessage(e,s)),this._currentParams=Object(v.a)(e);try{this._isRestoring&&!s||await this._commandExecuter.executeActions(e,t,this._lastParams)}catch(e){if(this.params.actionsErrorToast&&!0===this.params.actionsErrorToast.show){const e="widgets.canvas.actions.error";let t=this.localize(e);t===e&&(t="Something went wrong. Send the website support team information about your browser and steps to reproduce the problem."),this.showToast(t,this.params.actionsErrorToast.duration)}this.logger.error(()=>"Failed to perform an action on Customer's Canvas. ",e)}finally{this.showPreloader(!1),this._lastParams=Object(v.a)(this._currentParams),this.actionsFinished=!0,this._isRestoring&&(this.getInitialParamsResolved(),this._isRestoring=!1)}}forceUpdateCanvas(){return this.__methodExecuter(()=>{spEditor.productHandler.getAllItems().map(e=>e.correspondingVObject).forEach(e=>e.update())})}connectedCallback(){super.connectedCallback(),this._commandExecuter=new w.a(this.commands,this.uniqWidgetName,()=>this.forceUpdateCanvas()),this.baseUrl=this.driver.settings.customersCanvasBaseUrl,this.showPreloader(!0),this.iframeApiPromise=f.a.loadCCScript(this.baseUrl,this.CC_SCRIPT_RELATIVE_PATH),this.iframeApiPromise.then(()=>{this.showPreloader(!1),CustomersCanvas.IframeApi.editorUrl=this.baseUrl})}switchSurfaceTo(e){return this.customersCanvasPromise.then(function(t){return t.getProduct().then(function(t){return t.switchTo(t.surfaces[e])})})}async removeSurface(e){const t=await this.customersCanvasPromise,s=await t.getProduct();if(e<0||e>s.surfaces.length-1)return console.error(`Invalid surface index: ${e}`),s;const a=s.surfaces[e];return await s.removeSurface(a)}async addSurface(e,t){const s=await this.customersCanvasPromise,a=await s.getProduct();return await a.addSurface(e,t)}async addSurfaces(e,t){const s=await this.customersCanvasPromise,a=await s.getProduct();return await a.addSurfaces(e,t)}async updateSurfaces(e,t){const s=await this.customersCanvasPromise;let a=await s.getProduct();switch(e.toLowerCase()){case"remove":a=await this.removeSurface(t);break;case"add":a=await this.addSurface(t)}return a}fireChangeItemEvent(e){this.onChange(e)}updateModifiedItem(e){Object(I.a)(this.modifiedItem,e)||(this.modifiedItem=e,this.emitChange({modifiedItem:this.modifiedItem},!1))}updateOverallBounds(e){Object(I.a)(this.overallBounds,e)||(this.overallBounds=e,this.emitChange({overallBounds:this.overallBounds},!1))}updateCurrentSurfaceName(){this.__methodExecuter(()=>spEditor.model.product.getCurrentSurface().name).then(e=>this._currentSurfaceName=e)}async applyViewerSettings(e){return this.commands.setViewerSettings.execute(e)}async getProofImages(e=800,t=800){let s=await this.customersCanvasPromise,a=await s.getProofImages({maxWidth:e,maxHeight:t});return this._proofImageUrls=a.proofImageUrls.map(e=>e.map(e=>e)),this.emitChange({urls:this.proofImageUrls},!0),a.proofImageUrls.map(e=>e[0])}async getHiResImages(e=800,t=800,s,a){let i=await this.customersCanvasPromise;null!==s&&""!==s||(s=void 0);const o=await i.finishProductDesign({stateId:s,proofMaxWidth:e,proofMaxHeight:t,fileName:a});return this._hiResUrls=o.hiResOutputUrls,this._proofImageUrls=o.proofImageUrls.map(e=>e.map(e=>e)),this._stateId=o.stateId,this._userId=o.userId,this._userChanges=o.userChanges,this._violationWarningData=o.violationWarningData,this._boundsData=o.boundsData,this.emitChange({urls:this.hiResUrls,proofs:this.proofImageUrls,stateId:this.stateId,userId:this.userId,userChanges:this.userChanges,violationWarningData:this.violationWarningData,boundsData:this.boundsData},!0),o.hiResOutputUrls}async getVariableData(){let e=await this.customersCanvasPromise,t=await e.getProduct();return this._variableData=(await t.getVariableItems()).reverse(),this.emitChange({data:this.variableData}),this.variableData}async getAllItems(){let e=await this.customersCanvasPromise,t=await e.getProduct();return this._allItems=(await t.getAllItems()).reverse(),this.emitChange({data:this._allItems}),this.allItems}async getDepositPhotos(){let e=await this.customersCanvasPromise,t=await e.eval(()=>{let e=[];return spEditor.model.product.getAllItems().forEach(t=>{let s=t instanceof CustomersCanvas.Model.PlaceholderItem&&null!=t.content&&"ImageItem"===t.content.type?t.content:t,a=s.tags.dp_data||s.tags.sourceData;if(a&&null!=a.thumb_max){const s="string"==typeof a?JSON.parse(a).id:a.id,i="string"==typeof a?JSON.parse(a).thumb_max:a.thumb_max;e.push({imageId:t.id,depositPhotosId:s,preview:i})}}),e});return this._depositPhotos=t,this.emitChange({data:this.depositPhotos}),t}async getTags(){const e=await this.customersCanvasPromise,t=await e.getProduct(),s=await t.getTags();return this._tags=s,this.emitChange({tags:this.tags}),Promise.resolve(s)}async setTags(e){const t=await this.customersCanvasPromise,s=await t.getProduct();return await s.setTags(e),this._tags=e,this.emitChange({tags:this.tags}),Promise.resolve(e)}async saveProduct(e){return this.customersCanvasPromise.then(t=>t.saveProduct(e).then(e=>(this._stateId=e.stateId,this._userId=e.userId,this.emitChange({stateId:e.stateId,userId:e.userId},!0),e)))}replaceInterpolationPlaceholder(){if(!this._currentParams.replaceInterpolationPlaceholders)return Promise.resolve();return this.__methodExecuter(()=>spEditor.productHandler.replaceInterpolationPlaceholders())}toggleMaximizeMainPanel(e){this.publishData({main:e},C.a.TOGGLE_SIZE_MAIN)}openAssetManagerFor(e){this.__methodExecuter(e=>{const t=spEditor.productHandler.getAllItems().find(t=>t.name===e);(t instanceof CustomersCanvas.Model.ImageItem||t instanceof CustomersCanvas.Model.PlaceholderItem)&&spEditor.widgetsController.requestSetImage(t)},e)}toggleObjectInspector(){this.__methodExecuter(()=>{spEditor.widgetsController.toggleObjectInspector(),spEditor.widgetsController.updateWidgets()})}async getItemText(e){const t=await this.customersCanvasPromise,s=await t.eval(e=>{let t="";const s=spEditor.model.product.getAllItems().find(t=>t.name===e);if(s&&s instanceof CustomersCanvas.Model.BaseTextItem){t=s.text}return t},e);return this.itemsData[e]=this.itemsData[e]||{},this.itemsData[e].text=s,this.emitChange(),s}getPreloaderMessage(e,t){var s,a,i,o;return t?null!==(a=null===(s=null===e||void 0===e?void 0:e.preloader)||void 0===s?void 0:s.initialMessage)&&void 0!==a?a:this.localize("common.loading.preload"):null!==(o=null===(i=null===e||void 0===e?void 0:e.preloader)||void 0===i?void 0:i.actionsMessage)&&void 0!==o?o:this.localize("common.loading.preload")}};Object(i.b)([Object(p.c)(),Object(i.d)("design:type",l)],b.prototype,"modifiedItem",void 0),b=Object(i.b)([Object(p.a)("au-widget-canvas",o)],b)}}]);